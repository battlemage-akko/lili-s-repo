{% load static %}
<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="{% static 'css/videos.css' %}" rel="stylesheet">
    <link href="{% static 'css/topbar.css' %}" rel="stylesheet">
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <link rel="shortcut icon" href="{% static 'images/video.PNG' %}">
    <link href="{% static 'css/root.css' %}" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/video.js/7.15.0/alt/video-js-cdn.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/video.js/7.15.0/alt/video.core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <title>{{ v_title }}</title>
    <style>
        @font-face {
            font-family: 'IcoMoon-Free';
            src: url('{% static 'css/IcoMoon-Free.ttf' %}') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        body {
            background-color: var(--Background-color);
            overflow-x: hidden;
            transition: all .5s ease;
            width: 100vw;
            height: 100vh;
        }

        body::-webkit-scrollbar {
            width: 5px;
            height: 5px;
            scrollbar-arrow-color: red;
        }

        body::-webkit-scrollbar-thumb { /*滚动条里面小方块*/
            border-radius: 5px;
            -webkit-box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
            background: rgba(0, 0, 0, 0.4);
            scrollbar-arrow-color: red;
        }

        body::-webkit-scrollbar-track { /*滚动条里面轨道*/
            -webkit-box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
            border-radius: 0;
            background: rgba(0, 0, 0, 0.1);
        }

        #app {
            transition: padding-left .5s ease;
        }
        ul{
            padding-left: 0;
        }
        .videos {
            width: 100vw;
            height: 100vh;
            right: 0;
            justify-content: center;
            white-space: nowrap;
            display: flex;
            margin: 0px 30px;
            overflow: auto;
        }
    </style>
</head>
<body>
{% include 'topbar.html' %}
<div id="app">
    <div class="videos-accusation" v-show="AccMenu">
        <div class="videos-accusation-content">
            <div class="videos-accusation-title">
                <span></span>
                <span style="font-size: 16px">举报</span>
                <span style="cursor: pointer" @click="closeAccMenu">cancel</span>
            </div>
            <div class="videos-accusation-warning">
                <span style="color: red;font-size: 20px;margin: 0px 20px">warning</span>
                <span style="color: black;display: flex;align-items: center;font-size: 15px">禁止恶意举报行为</span>
            </div>
            <div class="videos-accusation-reason">
                <div class="form-floating">
                    <textarea class="form-control" placeholder="Leave a comment here" id="floatingTextarea2"
                              style="height: 150px" v-model="AccReason" maxlength="100"></textarea>
                    <label for="floatingTextarea2">请描述举报理由:</label>
                </div>
                <ul class="videos-accusation-btns">
                    <li style="font-family: '微软雅黑 Light'">{[ AccReason.length ]}/100字 <p style="color: red">{[ AccResult
                        ]}</p></li>
                    <li>
                        <button type="button" class="btn btn-outline-secondary" @click="report">提交</button>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div class="videos" @scroll="listenScroll">
        <div class="videos-holder">
            <div class="videocontent">
                <div class="videotitle-holder">

                </div>
                <div class="video-card">
                    <div class="thisvideo">
                        <div id="barrage" @click="pauseOrPlay">
                            <img src="{% static 'images/play.png' %}" alt="" class="playImg" v-show="!playing">
                        </div>
                        <video class="video-js vjs-default-skin vjs-big-play-centered vjs-fluid" id="video_ready">
                        </video>
                    </div>
                    <div class="play-tools">
                        <ul class="play-tools-main">
                            <li class="play-tools-refresh" title="重载" @click="reloadvideo"></li>
                            <li class="play-tools-stop" title="销毁"></li>
                        </ul>
                        <ul class="play-tools-main">
                            <li class="play-tools-choose">
                                {[ screen_choose ]}
                                <div class="choose-dropdown">
                                    <div>1080p</div>
                                    <div>720p</div>
                                    <div>480p</div>
                                    <div>auto</div>
                                </div>
                            </li>
                            <li class="fullscreen-sets"></li>
                            <li class="fullscreen-window"></li>
                        </ul>
                    </div>
                    <div class="danmucontent">
                        <div class="video-danmucontent-switch danmu-switch" style="width: 200px">
                            <div class="form-check form-switch" style="display: flex;justify-content: right">
                                <input class="form-check-input" type="checkbox" role="switch"
                                       id="flexSwitchCheckChecked"
                                       checked>
                                <label class="form-check-label" for="flexSwitchCheckChecked"></label>
                            </div>
                            <ul class="danmu-btns">
                                <li class="text-weight">
                                    <div class="danmu-setting">
                                        <div>弹幕模式:</div>
                                        <ul class="danmu-setting-mode">
                                            <li class="active" @click="changeBarrageMode('move',$event)"><img src="{% static 'images/barrage_move.svg' %}" type="image/svg+xml" width="40" height="40" /><div>滚动</div></li>
                                            <li @click="changeBarrageMode('top',$event)"><img src="{% static 'images/barrage_top.svg' %}" type="image/svg+xml" width="40" height="40" /><div>顶部</div></li>
                                            <li @click="changeBarrageMode('bottom',$event)"><img src="{% static 'images/barrage_bottom.svg' %}" type="image/svg+xml" width="40" height="40" /><div>底部</div></li>
                                        </ul>
                                        <div>弹幕颜色:</div>
                                        <ul></ul>
                                    </div>
                                </li>
                            </ul>
                        </div>
                        <div class="video-danmucontent-switch" style="flex-grow: 1">
                            <div class="danmu-input-group">
                                <button class="danmu-input-group-send" @click="send_msg_check">发送</button>
                                <input type="text" placeholder="发个弹幕试试吧~" id="danmu_content" v-model="input">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="videodetail">
                    <ul class="video-title-span">
                        <li>
                            <i class="date"></i>&nbsp;{{ v_time.v_time_year }}年{{ v_time.v_time_month }}月{{ v_time.v_time_day }}日 {{ v_time.v_time_hour }}:{{ v_time.v_time_minute }}:{{ v_time.v_time_second }}
                        </li>
                        <li><i class="play"></i>&nbsp;{[ video_detail.v_play ]}</li>
                        <li><i class="good"></i>&nbsp;{[ video_detail.v_like ]}</li>
                        <li><i class="collect"> </i>&nbsp;{[ video_detail.v_collect ]}</li>
                    </ul>
                    <h1 class="video-title"><span class="play2" style="margin-right: 5px"></span> {{ v_title }}</h1>
                </div>
                <div class="videos-tags">
                    <ul class="videos-tags-list">
                        <li class="videos-tags-each" v-for="(item,index) in tags" @click="searchByTag(item)">{[ item
                            ]}
                        </li>
                    </ul>
                </div>
                <div class="video-profile">
                    <div style="display: flex;width:200px;">
                        <span class="video-profilepic">
                            <img :src="avatar_url+video_detail.u_pic" alt="" @click="toProfile(video_detail.user_id)">
                        </span>
                        <span class="video-profile-name">
                           <div><a href="javascript:" @click="toProfile(video_detail.user_id)">{{ v_auther }}</a></div>
                            <a href="javascript:" style="font-size: 10px">{{ fans }} 位订阅者</a>
                        </span>
                    </div>
                    <div class="follow-holder" @click="follow">
                        <div class="follow">
                            <div style="margin:0px 10px" class="follow-content">
                                <span class="follow-btn">add</span> <span class="follow-text"> 求关注</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="video-discuss" v-if="is_login">
                    <div class="video-discuss-content">
                        <div class="video-discuss-profile" >
                            <img :src="avatar_url+userdetail.picture" alt="">
                        </div>
                        <div class="form-floating video-discuss-input">
                          <textarea class="form-control video-discuss-input-area" placeholder="Leave a comment here"
                                    id="floatingTextarea" @focus="changeInputMode('discuss')" @blur="changeInputMode('discuss')"
                                    v-model="discuss">
                          </textarea>
                            <label class="video-discuss-input-line" for="floatingTextarea">
                                评论 :
                            </label>
                        </div>
                    </div>
                    <div class="video-discuss-btns">
                        <ul class="video-discuss-btns-content">
                            <li style="border: none">{[ discuss_msg ]}</li>
                            <li @click="sendDiscussion"><span>发表评论</span></li>
                        </ul>
                    </div>
                </div>
                <div class="videos-discuss-login" v-if="!is_login">
                    <img src="{% static 'images/please.png' %}" alt="">
                    请先<span @click="login">登录</span>再评论哦~
                </div>
                <h2 style="padding: 2px 0px 20px 0px;font-size: 20px;border-bottom: 1px solid rgba(0,0,0,0.05);margin: 0">
                    {[ video_detail.d_content.length ]} 条评论</h2>
                <ul class="video-discuss-list">
                    <li v-for="(item,index) in video_detail.d_content" class="video-discuss-list-each"
                        :id="'discuss_'+item.d_id">
                        <div class="video-discuss-list-each-div">
                            <div class="video-discuss-list-each-pic">
                                <img :src="avatar_url+item.userdetail.picture" alt="" @click="toProfile(item.u_id)" style="cursor: pointer">
                            </div>
                            <div class="video-discuss-list-each-content">
                                <div>
                                    <h2 style="font-size: 12px;letter-spacing: 1px;margin-bottom: 5px;font-weight: 600;cursor: pointer" @click="toProfile(item.u_id)">
                                        {[item.userdetail.username]}
                                    </h2>
                                    <p style="white-space: normal;">
                                        {[item.d_content]}
                                    </p>
                                </div>
                                <div class="video-discuss-list-each-btns">
                                    <span>{[ item.d_time.d_time_year ]}年{[ item.d_time.d_time_month ]}月{[ item.d_time.d_time_day ]}日 {[ item.d_time.d_time_hour ]}:{[ item.d_time.d_time_minute ]}:{[ item.d_time.d_time_second ]}</span>
                                    <span class="heart"> 0</span>
                                    <span class="heart-broken"> 0</span>
                                    <span @click="showAnswer(item.d_id)" style="cursor: pointer">回复</span>
                                    <span @click="delDiscussion(item.d_id)" style="cursor: pointer" v-if="userdetail.id==video_detail.user_id || userdetail.id==item.u_id">删除</span>
                                </div>
                            </div>
                        </div>
                        <div class="video-discuss-list-each-div">
                            <div class="video-answer-container">
                                <ul class="video-answer-list-container">
                                    <li v-for="(answer,index) in item.answer" class="video-answer-list-each" >
                                        <div class="video-answer-list-each-content">
                                            <img :src="avatar_url+answer.userdetail.picture" alt="" @click="toProfile(answer.u_id)" style="cursor: pointer">
                                            <div class="video-answer-list-each-word"><span @click="toProfile(answer.u_id)" style="cursor: pointer"> {[ answer.userdetail.username ]}</span> : {[ answer.answer_content ]}</div>
                                        </div>
                                        <div class="video-answer-list-each-date">
                                            <span>{[ answer.answer_time.answer_time_year ]}年{[ answer.answer_time.answer_time_month ]}月{[ answer.answer_time.answer_time_day ]}日 {[ answer.answer_time.answer_time_hour ]}:{[ answer.answer_time.answer_time_minute ]}:{[ answer.answer_time.answer_time_second ]}
                                            </span>
                                            <span class="heart"> 0</span>
                                            <span class="heart-broken"> 0</span>
                                        </div>
                                    </li>
                                </ul>
                                <div class="video-answer-content" :id="'answer_'+item.d_id">
                                    <div class="video-answer-content-container">
                                        <div class="video-answer-profile">
                                            <img :src="avatar_url+userdetail.picture" alt="">
                                        </div>
                                        <div class="form-floating video-answer-input">
                                              <textarea class="form-control video-answer-input-area"
                                                        placeholder="Leave a comment here"
                                                        id="floatingTextarea" @focus="changeInputMode('answer')"
                                                        @blur="changeInputMode('answer')"
                                                        v-model="answerTmp[item.d_id]">
                                              </textarea>
                                            <label class="video-answer-input-line" for="floatingTextarea">
                                                回复 :
                                            </label>
                                        </div>
                                    </div>
                                    <ul class="video-answer-content-btns">
                                        <li></li>
                                        <li>
                                            <span @click="showAnswer(item.d_id)" style="cursor: pointer">取消</span>
                                            <span @click="sendAnswer(item.d_id)" style="cursor: pointer">回复</span>
                                        </li>
                                    </ul>
                                </div>
                                <hr>
                            </div>
                        </div>
                    </li>
                </ul>
                <div class="video-no-discuss" v-if="video_detail.d_content.length==0">快来发一条评论吧~</div>
            </div>
            <div class="danmu">
                <div class="ad">
                </div>
                <div class="danmuholder">
                    <div class="danmutitle">
                        <div class="danmutitlecontent">
                            <ul class="danmutitle-btn-list">
                                <li>
                                    <div class="video-danmucontent-switch">
                                        <ul class="videobtns">
                                            <li><span class="pay"></span></li>
                                            <li><span class="share"></span></li>
                                            <li><span class="good" @click="love"></span></li>
                                            <li><span class="collect" @click="collect"></span></li>
                                            <li><span class="accusation" @click="showAccMenu"></span></li>
                                        </ul>
                                    </div>
                                </li>
                                <li style="margin-right: 10px">弹幕列表 <i class="danmubtn"></i></li>
                            </ul>
                        </div>
                        <div style="position: relative;height: 25px;font-size: 10px;line-height: 25px;background-color: rgba(0,0,0,0.05)">
                            <span style="width: 50px;border-left: 1px solid rgba(0,0,0,0.1);padding-left: 5px">时间</span>
                            <span style="width: 100px;border-left: 1px solid rgba(0,0,0,0.1);padding-left: 5px">内容</span>
                            <span style="width: 70px;border-left: 1px solid rgba(0,0,0,0.1);padding-left: 5px">发布时间</span>
                        </div>
                        <ul class="danmulist">
                            <li v-for="(item,i) in barrageArray">
                                <span>{[ Math.floor(item.b_time/60)<10?"0"+Math.floor(item.b_time/60):Math.floor(item.b_time/60) ]}:{[item.b_time%60<10?"0"+(item.b_time%60):item.b_time%60]}</span>
                                <span>{[ item.b_content ]}</span>
                                <span>null</span>
                                <span><a href="javascript:" style="text-decoration: none">举报</a></span>
                            </li>
                        </ul>

                    </div>
                </div>
                <div class="videolistcontent">
                    <div style="margin: 20px 0px;font-size: 16px;display: inline-block;height: 20px">
                        接下来播放
                        <div style="display: inline-block;position:relative;margin-left: 10px">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch"
                                       id="flexSwitchCheckChecked"
                                       checked>
                                <label class="form-check-label" for="flexSwitchCheckChecked"></label>
                            </div>
                        </div>
                    </div>
                    <div class="nextvideo">
                        <div style="background: url('{% static 'videos/videopic/' %}{{ nextvideo.v_pic }}') center center no-repeat;background-size: cover;background-color: black;cursor: pointer"
                             @click="getVideo({{ nextvideo.v_id }})"></div>
                        <div class="videoslist-info">
                            <a href="javascript:" @click="getVideo({{ nextvideo.v_id }})">{{ nextvideo.v_title }}</a>
                            <a href="javascript:">作者：{{ nextvideo.v_auther }}</a>
                            <a href="javascript:" @click="getVideo({{ nextvideo.v_id }})">{{ nextvideo.v_play }} 播放 0
                                弹幕</a>
                        </div>
                    </div>
                    <ul class="videoslist">
                        {% for item in nextvideolist %}
                            <li>
                                <div style="background: url('{% static 'videos/videopic/' %}{{ item.v_pic }}') center center no-repeat;background-size: cover;background-color: black;cursor: pointer"
                                     @click="getVideo({{ item.v_id }})"></div>
                                <div class="videoslist-info">
                                    <a href="javascript:" @click="getVideo({{ item.v_id }})">{{ item.v_title }}</a>
                                    <a href="javascript:">作者：{{ item.v_auther }}</a>
                                    <a href="javascript:" @click="getVideo({{ item.v_id }})">{{ item.v_play }} 播放 0
                                        弹幕</a>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                    <div style="width: 100%;height: 30px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script>
    const vm = new Vue({
        el: "#app",
        delimiters: ['{[', ']}'],
        data: {
            barrageWidth: document.querySelector('.thisvideo').clientWidth,
            barrageTipWidth: 50,
            screenWidth: document.body.clientWidth,
            nextbarrageTop: 0,
            screen_choose: "auto",
            oncechance:{{ oncechance }},
            followornot: {{ followornot }},
            loveornot:{{ loveornot }},
            collectornot:{{ collectornot }},
            barrage_mode:{
                move:true,
                top:false,
                bottom:false,
            },
            video_detail: {
                "v_id": {{ v_id }},
                "v_ad": "{{ v_ad }}",
                "v_pic": "{{ v_pic }}",
                "v_auther": "{{ v_auther }}",
                "v_play": {{ v_play }},
                "v_title": "{{ v_title }}",
                "v_collect": {{ v_collect }},
                "v_like": {{ v_like }},
                "user_id": {{ user_id }},
                "u_pic":"{{ u_pic }}",
                "v_tags": "{{ v_tags }}",
                "d_content": {{ discuss|safe }},
            },
            userdetail:topbar.userdetail,
            video_option: {
                controls: true,
                autoplay: true,
                preload: "none",
                playbackRates: [0.5, 1, 1.5, 2],
                attributes: true,
                childList: true,
                characterData: true,
                poster: '{% static 'images/3.jpg' %}',
                sources: [
                    {
                        src: '{% static "videos/" %}{{ v_ad }}',
                        type: 'video/mp4',
                    }
                ]
            },
            video_ready: "",
            video_nowtime: 0,
            barrageArray: [],
            barrage_divNode: "",
            tags: [],
            input: "",
            fromhere: 0,
            is_login: topbar.is_login,
            AccMenu: false,
            playing:false,
            AccReason: "",
            AccResult: "",
            username: "",
            q: "",
            video_url:"{% url "index" %}"+"video/",
            base_url:"{% url 'index' %}"+"search?q=",
            avatar_url: topbar.avatar_url,
            discuss: "",
            discuss_msg: "",
            answerTmp:{},
            videosList_isLoading:false,
        },
        methods: {
            changeBarrageMode:function (mode,e){
                for(let key in this.barrage_mode){
                    this.barrage_mode[key]=false
                }
                this.barrage_mode[mode]=true
                lis = document.querySelector('.danmu-setting-mode').querySelectorAll('li')
                for(let li of lis){
                    li.classList.remove('active')
                }
                e.currentTarget.classList.add('active')
            },
            toProfile:function (id){
                topbar.toProfile(id)
            },
            login:function() {
                topbar.login()
            },
            showAnswer:function (id){
                    document.querySelector('#answer_'+id).classList.toggle('active')
                    answerTextarea = document.querySelector('#answer_'+id).querySelector('.video-answer-input').querySelector('textarea')
                    for(let item of document.querySelector('#answer_'+id).classList){
                        if(item=='active'){
                            answerTextarea.focus()
                            return
                        }
                    }
                    answerTextarea.blur()
            },
            searchByTag: function (tag) {
                window.open(this.base_url + tag)
            },
            changeInputMode: function (string) {
                if(string=='answer'){
                    document.querySelector(".video-answer-input-area").classList.toggle("active")
                    document.querySelector(".video-answer-input-line").classList.toggle("active")
                }
                else if(string=='discuss'){
                    document.querySelector(".video-discuss-input-area").classList.toggle("active")
                    document.querySelector(".video-discuss-input-line").classList.toggle("active")
                }
                else{
                    return
                }
            },
            showAccMenu: function () {
                if (this.is_login) {
                    this.AccMenu = true
                    document.querySelector('.videos-accusation').classList.add('active')
                } else {
                    this.login()
                }
            },
            closeAccMenu: function () {
                this.AccMenu = false
                document.querySelector('.videos-accusation').classList.remove('active')
            },
            sendDiscussion: async function () {
                if(this.discuss.trim().split(' ') == ""){
                    alert("空的")
                    return
                }
                let param = new URLSearchParams()
                param.append('d_content', this.discuss)
                param.append('u_id', this.userdetail.id)
                param.append('v_id', this.video_detail.v_id)
                result = await axios({
                    method: "POST",
                    data: param,
                    url: "{% url 'sendDiscussion' %}"
                })
                this.discuss_msg = result.data.msg
                if(result.data.result.length == 1){
                    this.video_detail.d_content.unshift(result.data.result[0])
                }
                this.discuss = ""
            },
            sendAnswer: async function (d_id) {
                let param = new URLSearchParams()
                param.append('answer_content', this.answerTmp[d_id])
                param.append('u_id', this.userdetail.id)
                param.append('v_id', this.video_detail.v_id)
                param.append('d_id', d_id)
                result = await axios({
                    method: "POST",
                    data: param,
                    url: "{% url 'sendAnswer' %}"
                })
                for(let item of this.video_detail.d_content){
                    if(result.data.result.d_id == item.d_id){
                        item.answer.unshift(result.data.result)
                    }
                }
                this.answerTmp[d_id] = ""

            },
            played: async function (id) {
                let param = new URLSearchParams()
                param.append('v_id', id)
                this.oncechance -= 1
                result = axios({
                    method: "POST",
                    url: "{% url "hasbeenplayed" %}",
                    data: param
                })
            },
            send_msg_check: function () {
                if (this.is_login) {
                    this.sendMsg()
                } else {
                    let choose = window.confirm("登录后才可以发弹幕哦，是否需要登录")
                    if (choose == true) {
                        window.open("{% url 'login' %}", "_blank");
                    } else {
                        return
                    }
                }
            },
            createBarrage: function (msg, isSendMsg) {
                let divNode = document.createElement('div');
                let spanNode = document.createElement('span');

                divNode.innerHTML = msg;
                divNode.classList.add('barrage-item');
                barrageBox.appendChild(divNode);
                spanNode.innerHTML = '举报';
                spanNode.classList.add('barrage-tip');
                divNode.appendChild(spanNode);
                if (this.fromhere == 1) {
                    divNode.classList.add('barrage-item-active');
                    this.fromhere = 0
                }
                barrageOffsetLeft = barrageWidth
                barrageOffsetTop = this.nextbarrageTop
                this.nextbarrageTop += 30
                //执行初始化滚动

                this.barrage_divNode = divNode
                this.initBarrage.call(divNode, {
                    left: barrageOffsetLeft,
                    top: barrageOffsetTop,
                });
            },
            sendMsg: function () {
                let inputValue = this.input
                this.fromhere = 1
                inputValue.replace(/\ +/g, "");
                if (inputValue.length <= 0) {
                    alert('空的，尼玛')
                    return false;
                }
                mode = ""
                for(let key in this.barrage_mode){
                    if(this.barrage_mode[key] == true){
                        mode = key
                    }
                }
                tmp = {
                    b_mode: mode,
                    b_content: inputValue,
                    b_time: Math.ceil(vm.video_ready.currentTime()),
                }
                this.send_Msg_to_server(tmp)
                this.barrageArray.unshift(tmp)
                this.input = ''
            },
            send_Msg_to_server: async function (tmp) {
                let param = new URLSearchParams()
                param.append('b_auther', this.username)
                param.append('b_content', tmp.b_content)
                param.append('b_time', tmp.b_time)
                param.append('v_id', this.video_detail.v_id)
                param.append('b_mode', tmp.b_mode)
                result = await axios({
                    method: "POST",
                    data: param,
                    url: "{% url 'save_barrage' %}"
                })
            },
            move: function (obj) {
                if (-obj.width == obj.distance && obj.chance == 1) {
                    obj.distance -= 1
                    this.nextbarrageTop -= 30
                }
                obj.distance--;
                obj.style.transform = 'translate3D(' + obj.distance + 'px,0px,0px)';
            },
            barrageAnimate: function (obj) {
                this.move(obj);
                if (Math.abs(obj.distance) < obj.width + obj.offsetLeft) {
                    obj.timer = requestAnimationFrame(function () {
                        vm.barrageAnimate(obj);
                    });
                } else {
                    cancelAnimationFrame(obj.timer);
                    //删除节点
                    obj.parentNode.removeChild(obj);
                }
            },
            initBarrage: function (obj) {
                this.barrage_divNode.distance = 0;
                this.barrage_divNode.chance = 1;
                this.barrage_divNode.offsetLeft = obj.left;
                this.barrage_divNode.style.top = obj.top + 'px';
                this.barrage_divNode.width = ~~window.getComputedStyle(this.barrage_divNode).width.replace('px', '');
                this.barrage_divNode.timer = null;
                //弹幕子节点
                let barrageChileNode = this.barrage_divNode.children[0];
                barrageChileNode.style.left = (this.barrage_divNode.width - this.barrageTipWidth) / 2 + 'px';

                //运动
                this.barrageAnimate(this.barrage_divNode);

                //停止
                this.barrage_divNode.onmouseenter = function () {
                    barrageChileNode.style.display = 'block';
                    cancelAnimationFrame(this.timer);
                };

                this.barrage_divNode.onmouseleave = function () {
                    barrageChileNode.style.display = 'none';
                    if(vm.playing)
                        vm.barrageAnimate(this);
                    else{
                        return
                    }
                };

                //举报
                barrageChileNode.onclick = function () {
                    alert('举报成功');
                }
            },
            getBarrage: async function () {
                let param = new URLSearchParams()
                param.append('v_id', {{ v_id }})
                result = await axios({
                    method: "POST",
                    url: "{% url "loadbarrage" %}",
                    data: param,
                })
                this.barrageArray = result.data
            },
            test: function () {
                this.barrageArray.forEach(function (item, index) {
                    console.log(item.text)
                    vm.createBarrage(item.text, false)
                });
            },
            getVideo: function (v_id) {
                window.open(this.video_url + v_id)
            },
            reloadvideo: function () {
                this.video_ready.load()
                console.log("重载")
            },
            follow: async function () {
                if(!this.is_login){
                    this.login()
                }
                let param = new URLSearchParams()
                param.append('follow_id', {{ request.user.id }})
                param.append('followed_id', {{ user_id }})
                result = await axios({
                    method: "POST",
                    url: "{% url "follow" %}",
                    data: param,
                })
                this.followornot = result.data.code

            },
            love: async function () {
                if(!this.is_login){
                    this.login()
                }
                let param = new URLSearchParams()
                param.append('user_id', {{ request.user.id }})
                param.append('video_id', this.video_detail.v_id)
                param.append('status', this.loveornot)
                result = await axios({
                    method: "POST",
                    url: "{% url "love" %}",
                    data: param,
                })
                console.log(result.data.msg)
                this.loveornot = result.data.code
                if(result.data.code==1){
                    this.video_detail.v_like +=1
                }
                else{
                    this.video_detail.v_like -=1
                }
            },
            collect: async function () {
                if(!this.is_login){
                    this.login()
                }
                let param = new URLSearchParams()
                param.append('user_id', this.userdetail.id)
                param.append('video_id', this.video_detail.v_id)
                param.append('status', this.collectornot)
                result = await axios({
                    method: "POST",
                    url: "{% url "collect" %}",
                    data: param,
                })
                console.log(result.data.msg)
                this.collectornot = result.data.code
                if(result.data.code==1){
                    this.video_detail.v_collect +=1
                }
                else{
                    this.video_detail.v_collect -=1
                }
            },
            report: async function () {
                if (this.AccReason == "") {
                    this.AccResult = "丢你"
                    return
                }
                let param = new URLSearchParams()
                param.append('u_id', this.userdetail.id)
                param.append('v_id', this.video_detail.v_id)
                param.append('a_reason', this.AccReason)
                result = await axios({
                    method: "POST",
                    url: "{% url "report" %}",
                    data: param,
                })
                if (result) {
                    if (result.data.code == 1) {
                        this.AccResult = result.data.msg
                        setTimeout(function () {
                            vm.AccResult = ""
                        }, 3000);
                    } else if (result.data.code == 0) {
                        this.AccResult = result.data.msg
                        setTimeout(function () {
                            vm.AccResult = ""
                        }, 3000);
                    } else {
                        this.AccResult = "什么玩意?"
                    }
                }
                this.AccReason = ""
            },
            delAnswer: async function (a_id) {
                let param = new URLSearchParams()
                param.append('a_id', a_id)
                result = await axios({
                    method: "POST",
                    url: "{% url "report" %}",
                    data: param,
                })
            },
            pauseOrPlay: function (){
                if(this.playing){
                    this.video_ready.pause()
                }
                else{
                    this.video_ready.play()
                }
            },
            delDiscussion: async function (d_id) {
                let param = new URLSearchParams()
                param.append('d_id', d_id)
                result = await axios({
                    method: "POST",
                    url: "{% url "delDiscussion" %}",
                    data: param,
                })
                this.discuss_msg = result.data.msg
                if(result.data.code==1){
                    for(let item of this.video_detail.d_content){
                        if(item.d_id==d_id){
                            discussIndex = this.video_detail.d_content.indexOf(item)
                            document.querySelector('#discuss_'+d_id).classList.add("dying")
                            setTimeout(function(){
                                vm.video_detail.d_content.splice(discussIndex, 1)
                                document.querySelector('#discuss_'+d_id).classList.remove("dying")
                            },500);
                        }
                    }
                }
            },
            listenScroll:function(){
                if(document.querySelector('.videos').scrollTop + document.querySelector('.videos').offsetHeight > document.querySelector('.videos').scrollHeight - 40 &&  this.videosList_isLoading!=true){
                    this.videosList_isLoading=true
                    console.log(1)
                }
            }
        },
        mounted: function () {
            const that = this
            window.onresize = () => {
                return (() => {
                    window.screenWidth = document.body.clientWidth
                    that.screenWidth = window.screenWidth
                })()
            }
            tagsTmp = this.video_detail.v_tags.split(",")
            if (tagsTmp[0].toLowerCase() == "none") {
                this.tags.push("无标签")
            } else {
                this.tags = tagsTmp
            }
            this.video_ready = videojs("video_ready", this.video_option, function () {
                this.on('loadstart', function () {
                    console.log('loadstart')
                });
                this.off('timeupdate', function () {
                    console.log('off')
                });
                this.on('timeupdate', function () {
                    that .video_nowtime = Math.floor(vm.video_ready.currentTime())
                });
                this.on('pause', function () {
                    console.log("暂停")
                    that.playing = false
                    for (let i of document.querySelector("#barrage").querySelectorAll("div")) {
                        cancelAnimationFrame(i.timer);
                    }
                });
                this.on('play', function () {
                    console.log("播放")
                    that.playing = true
                    if (vm.oncechance == 1) {
                        that.played({{ v_id }})
                    }
                    that
                    for (let i of document.querySelector("#barrage").querySelectorAll("div")) {
                        that .barrageAnimate(i);
                    }
                });
                this.on("error", function () {
                    console.log("加载错误")
                });
                this.on("stalled", function () {
                    console.log("网速异常");
                })
            })
            if (this.video_ready.readyState() == 0) {
                this.video_ready.options_.sources = [
                    {
                        src: '{% static "videos/" %}{{ v_ad }}',
                        type: 'video/mp4',
                    }
                ]
                this.reloadvideo()
            }
            if (this.followornot == 1) {
                document.querySelector('.follow-btn').innerHTML = "tick"
                document.querySelector('.follow-text').innerHTML = "已关注"
            } else if (this.followornot == 2) {
                document.querySelector('.follow-btn').innerHTML = "add"
                document.querySelector('.follow-text').innerHTML = "求关注"
            }
            if (this.loveornot == 1) {
                document.querySelector(".videobtns").querySelector('.good').classList.toggle("active")
            }
            if (this.collectornot == 1) {
                document.querySelector(".videobtns").querySelector(".collect").classList.toggle("active")
            }
            this.getBarrage()
            if (this.video_detail.user_id == '{{ request.user.id }}') {
                document.querySelector(".follow").style.display = "none"
            }
        },
        watch: {
            followornot: function () {
                if (this.followornot == 1) {
                    document.querySelector('.follow-btn').innerHTML = "tick"
                    document.querySelector('.follow-text').innerHTML = "已关注"
                    alert("关注成功")
                } else if (this.followornot == 2) {
                    document.querySelector('.follow-btn').innerHTML = "add"
                    document.querySelector('.follow-text').innerHTML = "求关注"
                    alert("取关成功")
                }
            },

            loveornot: function () {
                document.querySelector(".videobtns").querySelector('.good').classList.toggle("active")
            },
            collectornot: function () {
                document.querySelector(".videobtns").querySelector(".collect").classList.toggle("active")
            },
            video_nowtime: function () {
                if (vm.barrageArray.length != 0)
                    while (vm.barrageArray.length != 0 && vm.barrageArray[0].b_time <= vm.video_nowtime) {
                        let tmp = vm.barrageArray.shift()
                        this.createBarrage(tmp.b_content, false)
                    }
            },
            screenWidth(val){
                // 为了避免频繁触发resize函数导致页面卡顿，使用定时器
                if(!this.timer){
                    this.screenWidth = val
                    this.timer = true
                    let that = this
                    setTimeout(function(){
                        that.timer = false
                    },200)
                }
            },

        }
    })
    let inputBox = document.querySelector("#danmu_content")
    let sendBtn = document.querySelector("#send_danmu")
    let video = document.querySelector('.thisvideo')
    let barrage_height = video.clientHeight
    let barrage_width = video.clientWidth
    let send_btn = document.querySelector("#send_danmu")
    let danmu_content = document.querySelector("#danmu_content")
    let barrageBox = document.querySelector("#barrage")
    let barrageWidth = barrage_width
    let barrageHeight = barrage_height
    let danmulistbtn = document.querySelector('.danmubtn')
    let danmu = document.querySelector(".danmuholder")
    let danmulist = document.querySelector('.danmulist')
    let danmuflag = 0
    danmulistbtn.addEventListener("click", (e) => {
        danmulistbtn.classList.toggle("active")
        if (!danmuflag) {
            danmu.style.height = video.clientHeight + 90 + 'px'
            danmuflag = 1
            danmulist.style.height = video.clientHeight + 90 + 'px'
        } else {
            danmuflag = 0
            danmu.style.height = 50 + 'px'
        }
    })
    let nextbarrageTop = 0

</script>
</html>