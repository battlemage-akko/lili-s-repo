{% load static %}
<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="{% static 'css/videos.css' %}" rel="stylesheet">
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <link rel="shortcut icon" href="{% static 'images/video.PNG' %}">
    <link href="//cdn.bootcss.com/video.js/7.0.0-alpha.1/alt/video-js-cdn.css" rel="stylesheet">
    <script src="//cdn.bootcss.com/video.js/7.0.0-alpha.1/video.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <title>{{ v_title }}</title>
    <style>
        :root {
            --Head-top: 100px;
            --Test-color: null;
            --Background-color: #eeeef3;
            --shadow: 0 3px 3px 0 rgba(54, 58, 80, 0.32);
        }

        @font-face {
            font-family: 'IcoMoon-Free';
            src: url('{% static 'css/IcoMoon-Free.ttf'%}') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            scroll-behavior: smooth;
        }

        p {
            margin: 0 !important;
        }

        ul {
            padding-left: 0;
        }

        body {
            background-color: var(--Background-color);
            overflow-x: hidden;
            transition: all .5s ease;
        }

        #app {
            width: 100vw;
            height: 100vh;
            transition: padding-left .5s ease;
        }

        .videos {
            right: 0;
            justify-content: center;
            transition: all .5s ease;
            white-space: nowrap;
            display: flex;
            margin: 0px 30px;
        }
    </style>
</head>
<body>
<div id="app">
    <div class="warning-myself">
        <div>
            <img src="{% static "images/logo.png" %}" alt="" style="height: 40px;margin: 10px;cursor: pointer" onclick="window.location.href='{% url 'index' %}'">
        </div>
            <div class="input-group videos-top-search">
              <button class="btn btn-outline-secondary" type="button" id="button-addon1"><i class="videos-top-search-btn"></i></button>
              <input type="text" class="form-control" placeholder="搜索" aria-label="Example text with button addon" aria-describedby="button-addon1">
            </div>
        <ul class="video-user-info">
            <li>
                <i class="video-user-menus"></i>
            </li>
            <li>
                <i class="video-user-msg"></i>
            </li>
            <li>
                <img src="{% static 'images/' %}{{ request.user.picture }}" alt="" class="video-user-pic">
            </li>
        </ul>
    </div>
    <div class="videos">
        <div class="videos-holder">
            <div class="videocontent">
                <div class="videotitle-holder">

                </div>
                <div class="video-card">
                    <div class="thisvideo">
                        <div id="barrage"></div>
                        <video class="video-js vjs-default-skin vjs-big-play-centered vjs-fluid" id="video_ready">
                        </video>
                    </div>
                    <div class="play-tools">
                        <ul class="play-tools-main">
                            <li class="play-tools-refresh" title="重载" @click="reloadvideo"></li>
                            <li class="play-tools-stop" title="销毁"></li>
                        </ul>
                        <ul class="play-tools-main">
                            <li class="play-tools-choose">
                                {[ screen_choose ]}
                                <div class="choose-dropdown">
                                    <div>1080p</div>
                                    <div>720p</div>
                                    <div>480p</div>
                                    <div>auto</div>
                                </div>
                            </li>
                            <li class="fullscreen-sets"></li>
                            <li class="fullscreen-window"></li>
                        </ul>
                    </div>
                    <div class="danmucontent">
                        <div class="video-danmucontent-switch">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch"
                                       id="flexSwitchCheckChecked"
                                       checked>
                                <label class="form-check-label" for="flexSwitchCheckChecked"></label>
                            </div>
                        </div>
                        <div class="video-danmucontent-switch">
                            <div class="input-group">
                                <button class="btn btn-outline-secondary" type="button"
                                        id="send_danmu" @click="send_msg_check">发送弹幕
                                </button>
                                <input type="text" class="form-control" placeholder="发个弹幕试试吧"
                                       aria-label="Example text with button addon" aria-describedby="button-addon1"
                                       style="width: 20vw;min-width: 200px" id="danmu_content" v-model="input">
                            </div>
                        </div>
                        <div class="video-danmucontent-switch">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch"
                                       id="flexSwitchCheckChecked"
                                       checked>
                                <label class="form-check-label" for="flexSwitchCheckChecked"></label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="videodetail">
                    <ul class="video-title-span">
                        <li><i class="video-title-date"></i>&nbsp;{{ v_time.v_time_year }}年{{ v_time.v_time_month }}月{{ v_time.v_time_day }}日 {{ v_time.v_time_hour }}:{{ v_time.v_time_minute }}:{{ v_time.v_time_second }}</li>
                        <li><i class="video-title-play"></i>&nbsp;{{ v_play }}</li>
                        <li><i class="video-title-like"></i>&nbsp;{{ v_like }}</li>
                        <li><i class="video-title-collect"> </i>&nbsp;{{ v_collect }}</li>
                    </ul>
                    <h1 class="video-title">{{ v_title }}</h1>
                </div>
                <div class="video-profile">
                    <div style="display: flex;width:200px;">
                        <span class="video-profilepic">
                                        <img src="{% static 'images/头像.png' %}" alt="">
                                    </span>
                        <span class="video-profile-name">
                           <div><a href="javascript:">{{ v_auther }}</a></div>
                            <a href="javascript:" style="font-size: 10px">{{ fans }} 位订阅者</a>
                        </span>
                    </div>
                    <div class="follow-holder" @click="follow">
                        <div class="follow">
                            <div style="margin:0px 10px" class="follow-content">
                                <span class="follow-btn">add</span> <span class="follow-text"> 求关注</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="danmu">
                <div class="ad">

                </div>
                <div class="danmuholder">
                    <div class="danmutitle">
                        <div class="danmutitlecontent">
                            <ul class="danmutitle-btn-list">
                                <li>
                                    <div class="video-danmucontent-switch">
                                        <ul class="videobtns">
                                            <li><span class="videopay"></span></li>
                                            <li><span class="videoshare"></span></li>
                                            <li><span class="goodvideo"></span></li>
                                            <li><span class="videocollect"></span></li>
                                        </ul>
                                    </div>
                                </li>
                                <li style="margin-right: 10px">弹幕列表 <i class="danmubtn"></i></li>
                            </ul>
                        </div>
                        <div style="position: relative;height: 25px;font-size: 10px;line-height: 25px;background-color: rgba(0,0,0,0.05)">
                            <span style="width: 50px;border-left: 1px solid rgba(0,0,0,0.1);padding-left: 5px">时间</span>
                            <span style="width: 100px;border-left: 1px solid rgba(0,0,0,0.1);padding-left: 5px">内容</span>
                            <span style="width: 70px;border-left: 1px solid rgba(0,0,0,0.1);padding-left: 5px">发布时间</span>
                        </div>
                        <ul class="danmulist">
                            <li v-for="(item,i) in barrageArray">
                                <span>{[ Math.floor(item.b_time/60)<10?"0"+Math.floor(item.b_time/60):Math.floor(item.b_time/60) ]}:{[item.b_time%60<10?"0"+(item.b_time%60):item.b_time%60]}</span>
                                <span>{[ item.b_content ]}</span>
                                <span>null</span>
                                <span><a href="javascript:" style="text-decoration: none">举报</a></span>
                            </li>
                        </ul>

                    </div>
                </div>
                <div class="videolistcontent">
                    <div style="margin: 20px 0px;font-size: 16px;display: inline-block;height: 20px">
                        接下来播放
                        <div style="display: inline-block;position:relative;margin-left: 10px">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch"
                                       id="flexSwitchCheckChecked"
                                       checked>
                                <label class="form-check-label" for="flexSwitchCheckChecked"></label>
                            </div>
                        </div>
                    </div>
                    <div class="nextvideo">
                        <div style="background: url('{% static 'videos/videopic/' %}{{ nextvideo.v_pic }}') center center no-repeat;background-size: contain;background-color: black;cursor: pointer" @click="getVideo({{ nextvideo.v_id }})"></div>
                        <div>
                            <a href="javascript:" @click="getVideo({{ nextvideo.v_id }})">{{ nextvideo.v_title }}</a>
                            <a href="javascript:">作者：{{ nextvideo.v_auther }}</a>
                            <a href="javascript:" @click="getVideo({{ nextvideo.v_id }})">{{ nextvideo.v_play }} 播放 0 弹幕</a>
                        </div>
                    </div>
                    <ul class="videoslist">
                        {% for item in nextvideolist %}
                            <li>
                                <div style="background: url('{% static 'videos/videopic/' %}{{ item.v_pic }}') center center no-repeat;background-size: contain;background-color: black;cursor: pointer" @click="getVideo({{ item.v_id }})"></div>
                                <div>
                                    <a href="javascript:" @click="getVideo({{ item.v_id }})">{{ item.v_title }}</a>
                                    <a href="javascript:">作者：{{ item.v_auther }}</a>
                                    <a href="javascript:" @click="getVideo({{ item.v_id }})">{{ item.v_play }} 播放 0 弹幕</a>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                    <div style="width: 100%;height: 30px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script>
    const vm = new Vue({
        el: "#app",
        delimiters: ['{[', ']}'],
        data: {
            barrageWidth: document.querySelector('.thisvideo').clientWidth,
            barrageTipWidth: 50,
            nextbarrageTop: 0,
            screen_choose: "auto",
            oncechance:{{ oncechance }},
            followornot: {{ followornot }},
            video_detail: {
                "v_id": {{ v_id }},
                "v_ad": "{{ v_ad }}",
                "v_pic": "{{ v_pic }}",
                "v_auther": "{{ v_auther }}",
                "v_play": {{ v_play }},
                "v_title": "{{ v_title }}",
                "v_collect": {{ v_collect }},
                "v_like": {{ v_like }},
                "user_id": {{ user_id }},
                "followornot" : {{ followornot }}
            },
            video_option: {
                controls:true,
                autoplay:true,
                preload: "none" ,
                playbackRates: [0.5, 1, 1.5, 2],
                attributes: true,
                childList: true,
                characterData: true,
                poster: '{% static 'images/3.jpg' %}',
                sources: [
                    {
                        src: '{% static "videos/" %}{{ v_ad }}',
                        type: 'video/mp4',
                    }
                ]
            },
            video_ready: "",
            video_nowtime: 0,
            barrageArray: [],
            barrage_divNode: "",
            input: "",
            fromhere: 0,
            is_login: false,
            username: "",
            video_url:"{% url "index" %}"+"video/",
        },
        methods: {
            played: async function (id){
                let param = new URLSearchParams()
                param.append('v_id', id)
                this.oncechance -= 1
                result = axios({
                    method:"POST",
                    url:"{% url "hasbeenplayed" %}",
                    data:param
                })
            },
            is_login_check() {
                if ("{{ request.user.is_authenticated }}" == "True") {
                    this.is_login = true
                    this.username = "{{ request.user.username }}"
                } else {
                    this.is_login = false
                }
            },
            send_msg_check: function () {
                if (this.is_login) {
                    this.sendMsg()
                } else {
                    let choose = window.confirm("登录后才可以发弹幕哦，是否需要登录")
                    if (choose == true) {
                        window.open("{% url 'login' %}", "_blank");
                    } else {
                        return
                    }
                }
            },
            createBarrage: function (msg, isSendMsg) {
                let divNode = document.createElement('div');
                let spanNode = document.createElement('span');

                divNode.innerHTML = msg;
                divNode.classList.add('barrage-item');
                barrageBox.appendChild(divNode);
                spanNode.innerHTML = '举报';
                spanNode.classList.add('barrage-tip');
                divNode.appendChild(spanNode);
                if (this.fromhere == 1) {
                    divNode.classList.add('barrage-item-active');
                    this.fromhere = 0
                }
                barrageOffsetLeft = barrageWidth
                barrageOffsetTop = this.nextbarrageTop
                this.nextbarrageTop += 30
                //执行初始化滚动

                this.barrage_divNode = divNode
                this.initBarrage.call(divNode, {
                    left: barrageOffsetLeft,
                    top: barrageOffsetTop,
                });
            },
            sendMsg: function () {
                let inputValue = this.input
                this.fromhere = 1
                inputValue.replace(/\ +/g, "");
                if (inputValue.length <= 0) {
                    alert('空的，尼玛')
                    return false;
                }
                console.log(vm.video_ready.currentTime(),Math.ceil(vm.video_ready.currentTime()))
                tmp = {
                    b_content: inputValue,
                    b_time: Math.ceil(vm.video_ready.currentTime()),
                }
                this.send_Msg_to_server(tmp)
                this.barrageArray.unshift(tmp)
                this.input = ''
            },
            send_Msg_to_server: async function (tmp) {
                let param = new URLSearchParams()
                param.append('b_auther', this.username)
                param.append('b_content', tmp.b_content)
                param.append('b_time', tmp.b_time)
                param.append('v_id', {{ v_id }})
                result = await axios({
                    method:"POST",
                    data: param,
                    url: "{% url 'save_barrage' %}"
                })
            },
            move: function (obj) {
                if (-obj.width == obj.distance && obj.chance == 1) {
                    obj.distance -= 1
                    this.nextbarrageTop -= 30
                }
                obj.distance--;
                obj.style.transform = 'translate3D(' + obj.distance + 'px,0px,0px)';
            },
            barrageAnimate: function (obj) {
                this.move(obj);
                if (Math.abs(obj.distance) < obj.width + obj.offsetLeft) {
                    obj.timer = requestAnimationFrame(function () {
                        vm.barrageAnimate(obj);
                    });
                } else {
                    cancelAnimationFrame(obj.timer);
                    //删除节点
                    obj.parentNode.removeChild(obj);
                }
            },
            initBarrage: function (obj) {
                this.barrage_divNode.distance = 0;
                this.barrage_divNode.chance = 1;
                this.barrage_divNode.offsetLeft = obj.left;
                this.barrage_divNode.style.top = obj.top + 'px';
                this.barrage_divNode.width = ~~window.getComputedStyle(this.barrage_divNode).width.replace('px', '');
                this.barrage_divNode.timer = null;
                //弹幕子节点
                let barrageChileNode = this.barrage_divNode.children[0];
                barrageChileNode.style.left = (this.barrage_divNode.width - this.barrageTipWidth) / 2 + 'px';

                //运动
                this.barrageAnimate(this.barrage_divNode);

                //停止
                this.barrage_divNode.onmouseenter = function () {
                    barrageChileNode.style.display = 'block';
                    cancelAnimationFrame(this.timer);
                };

                this.barrage_divNode.onmouseleave = function () {
                    barrageChileNode.style.display = 'none';
                    vm.barrageAnimate(this);
                };

                //举报
                barrageChileNode.onclick = function () {
                    alert('举报成功');
                }
            },
            getBarrage: async function(){
                let param = new URLSearchParams()
                param.append('v_id', {{ v_id }})
                result = await  axios({
                    method :"POST",
                    url:"{% url "loadbarrage" %}",
                    data: param,
                })
                this.barrageArray = result.data
            },
            test: function () {
                this.barrageArray.forEach(function (item, index) {
                    console.log(item.text)
                    vm.createBarrage(item.text, false)
                });
            },
            getVideo:function (v_id){
                window.open(this.video_url+v_id)
            },
            reloadvideo:function (){
                this.video_ready.load()
                console.log("重载")
            },
            follow:async function (){
                let param = new URLSearchParams()
                param.append('follow_id', {{ request.user.id }})
                param.append('followed_id', {{ user_id }})
                result = await axios({
                    method :"POST",
                    url:"{% url "follow" %}",
                    data: param,
                })
                this.followornot = result.data.code
            }
        },
        mounted: function () {
            this.is_login_check()
            this.video_ready = videojs("video_ready", this.video_option, function () {
                this.on('loadstart', function () {
                    console.log('loadstart')
                });
                this.off('timeupdate', function () {
                    console.log('off')
                });
                this.on('timeupdate', function () {
                    vm.video_nowtime = Math.floor(vm.video_ready.currentTime())
                });
                this.on('pause', function () {
                    console.log("暂停")
                    for(let i of document.querySelector("#barrage").querySelectorAll("div")){
                        cancelAnimationFrame(i.timer);
                    }
                });
                this.on('play', function () {
                    console.log("播放")
                    if(vm.oncechance == 1){
                        vm.played({{ v_id }})
                    }
                    for(let i of document.querySelector("#barrage").querySelectorAll("div")){
                        vm.barrageAnimate(i);
                    }
                });
                this.on("error", function(){
                    console.log("加载错误")
                });
                this.on("stalled",function(){
                    console.log("网速异常");
                })
            })
            if(this.video_ready.readyState()==0){
                console.log("123")
                this.video_ready.options_.sources = [
                    {
                        src: '{% static "videos/" %}{{ v_ad }}',
                        type: 'video/mp4',
                    }
                ]
                this.reloadvideo()
            }
            if(this.followornot==1){
                document.querySelector('.follow-btn').innerHTML = "tick"
                document.querySelector('.follow-text').innerHTML = "已关注"
            }
            else if(this.followornot==2){
                document.querySelector('.follow-btn').innerHTML = "add"
                document.querySelector('.follow-text').innerHTML = "求关注"
            }
            this.getBarrage()
            if(this.video_detail.user_id == {{ request.user.id }}){
                document.querySelector(".follow").style.display = "none"
            }
        },
        watch: {
            followornot: function (){
                if(this.followornot==1){
                    document.querySelector('.follow-btn').innerHTML = "tick"
                    document.querySelector('.follow-text').innerHTML = "已关注"
                    alert("关注成功")
                }
                else if(this.followornot==2){
                    document.querySelector('.follow-btn').innerHTML = "add"
                    document.querySelector('.follow-text').innerHTML = "求关注"
                    alert("取关成功")
                }
            },
            video_nowtime: function () {
                if (vm.barrageArray.length != 0)
                    while (vm.barrageArray.length != 0 && vm.barrageArray[0].b_time <= vm.video_nowtime) {
                        let tmp = vm.barrageArray.shift()
                        this.createBarrage(tmp.b_content, false)
                    }
            }
        }
    })
    let inputBox = document.querySelector("#danmu_content")
    let sendBtn = document.querySelector("#send_danmu")
    let video = document.querySelector('.thisvideo')
    let barrage_height = video.clientHeight
    let barrage_width = video.clientWidth
    let send_btn = document.querySelector("#send_danmu")
    let danmu_content = document.querySelector("#danmu_content")
    let barrageBox = document.querySelector("#barrage")
    let barrageWidth = barrage_width
    let barrageHeight = barrage_height
    let danmulistbtn = document.querySelector('.danmubtn')
    let danmu = document.querySelector(".danmuholder")
    let danmulist = document.querySelector('.danmulist')
    let danmuflag = 0
    danmulistbtn.addEventListener("click", (e) => {
        danmulistbtn.classList.toggle("active")
        if (!danmuflag) {
            danmu.style.height = video.clientHeight + 90 + 'px'
            danmuflag = 1
            danmulist.style.height = video.clientHeight + 90 + 'px'
        } else {
            danmuflag = 0
            danmu.style.height = 50 + 'px'
        }
    })
    window.onresize = function () {
        console.log(video.clientWidth)
    }
    let nextbarrageTop = 0

</script>
</html>