<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<style>
    *{
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
     p {
         margin: 0 !important;
        }

    ul {
        margin: 0;
        padding-left: 0;
    }
    #app{
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }
    .upload-form{
        display: flex;
        justify-content: center;
        flex-direction: column;
        width: 500px;
    }
    .upload-form div{
        margin: 20px 0px;
    }
    body{
        width: 100vw;
        height: 100vh;
    }
</style>
<body>
    <div id="app">
        <form action="" class="upload-form">
            <div class="input-group">
              <label class="input-group-text" for="inputGroupFile01">视频(.mp4)</label>
              <input type="file" class="form-control" id="inputGroupFile01" @change="get_file($event)">
            </div>
            <div class="input-group">
              <label class="input-group-text" for="inputGroupFile01">封面(.jpg)</label>
              <input type="file" class="form-control" id="inputGroupFile01" @change="get_file($event)">
            </div>
            <div class="input-group">
              <span class="input-group-text">确认信息</span>
              <input type="text" aria-label="First name" class="form-control video_title" placeholder="输入标题" name="video_title" v-model="video_title">
              <input type="text" aria-label="Last name" class="form-control" placeholder="输入'1'确认信息无误" v-model="sure">
            </div>
            <div>
                <button type="button" class="btn btn-primary btn-sure" @click="upload_form_check">上传</button>
                <button type="button" class="btn btn-danger" @click="clear_input">取消</button>
                <button type="button" class="btn btn-danger">{[ pre ]}</button>
            </div>
        </form>
    </div>
</body>
<script>
const vm = new Vue({
    el: "#app",
    delimiters: ['{[', ']}'],
    data:{
        sure:0,
        video_pic:"",
        video_file:"",
        video_title:"",
        pre:"0%",
    },
    methods:{
        clear_input:function (){
            document.querySelector('.upload-form').querySelectorAll('input').forEach((item)=>{
                item.value = null
            })
            this.sure = 0
            this.video_title = ""
        },
        upload_form_check:function(){
          if(this.video_file==""){
              alert("请选择要上传的视频")
              return
          }
          if(this.video_pic==""){
              alert("请选择要上传的视频封面")
              return
          }
          if(this.video_title==""){
              alert("请填写视频标题")
              return
          }
          if(this.sure!=1){
              alert("请输入“1”确认")
              return
          }
          this.upload_form()
        },
        upload_form:async function (){
            let param = new FormData()
            param.append('video_pic',this.video_pic)
            param.append('video_file',this.video_file)
            param.append('video_title',this.video_title)
            param.append('username', "{{ request.user.username }}")
            param.append('user_id', "{{ request.user.id }}")
            document.querySelector('.upload-form').querySelectorAll('input').forEach((item)=>{
                item.disabled = "disabled"
            })
            document.querySelector('.btn-sure').disabled = "disabled"
            result = await axios({
                method: "POST",
                url:"{% url 'save_video' %}",
                onUploadProgress (progress) {
                    vm.pre = Math.round(progress.loaded / progress.total * 100) + '%';
                    if(vm.pre=="100%"){
                        vm.pre="0%"
                        document.querySelector('.upload-form').querySelectorAll('input').forEach((item)=>{
                            item.removeAttribute("disabled")
                        })
                        document.querySelector('.btn-sure').removeAttribute("disabled")

                        document.querySelector('.upload-form').querySelectorAll('input').forEach((item)=>{
                            item.value = null
                        })
                    }
                },
                data: param,
            })

        },
        get_file:function (e){
            let file = e.target.files[0]
            let fileName = file.name;
            let pos = fileName.lastIndexOf(".")
            let lastName = fileName.substring(pos, fileName.length)
            console.log(lastName)
            if(lastName.toLowerCase()=='.jpg'||lastName.toLowerCase()=='.jpeg'){
                this.video_pic = file
            }
            else if(lastName.toLowerCase()=='.mp4'){
                this.video_file = file
            }
            else{
                alert('上传的什么玩意？？？')
                e.target.value = null
            }
        }
    },
})
</script>
</html>